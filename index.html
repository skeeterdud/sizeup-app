<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MFD Size-Up Builder</title>

  <!-- iPhone / PWA settings -->
  <meta name="theme-color" content="#0b1a3a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --navy:#0b1a3a;
      --navy2:#111f42;
      --blue:#2563eb;
      --text:#0b1220;
      --muted: rgba(11,18,32,.75);

      --secOps:#fde68a;
      --secBuilding:#fecaca;
      --secProblem:#bbf7d0;
      --secIAP:#bfdbfe;
      --secStrategy:#ddd6fe;
      --secCommand:#fed7aa;
      --secFollow:#cffafe;

      --wmOpacity: 0.10;
      --wmSize: 820px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, #172554 0%, var(--navy) 55%) fixed;
      color:#e9eefc;
    }

    /* watermark */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background-image: url("logo.png");
      background-repeat: no-repeat;
      background-position: center;
      background-size: var(--wmSize);
      opacity: var(--wmOpacity);
      pointer-events: none;
      z-index: 0;
    }

    header{
      padding:14px 16px;
      background: rgba(17,31,66,.90);
      position: sticky;
      top:0;
      border-bottom: 1px solid rgba(255,255,255,.12);
      z-index: 2;
    }
    h1{margin:0;font-size:16px}
    .hint{color:rgba(233,238,252,.75);font-size:12px;margin-top:4px}

    .wrap{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      padding:12px;
      position:relative;
      z-index:1;
    }

    .card{
      background: rgba(18,26,43,.75);
      border: 1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
    }

    /* content blocks */
    .block{
      border-radius:16px;
      padding:12px;
      border:1px solid rgba(0,0,0,.10);
      color:var(--text);
    }
    .block h2{
      margin:0 0 10px 0;
      font-size:13px;
      letter-spacing:.5px;
      text-transform:uppercase;
      color:var(--text);
    }

    .ops{background:var(--secOps)}
    .building{background:var(--secBuilding)}
    .problem{background:var(--secProblem)}
    .iap{background:var(--secIAP)}
    .strategy{background:var(--secStrategy)}
    .command{background:var(--secCommand)}
    .follow{background:var(--secFollow)}

    /* IRR wrapper (title + 2 columns inside) */
    .irrWrap{
      border-radius:16px;
      padding:12px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.10);
      color:var(--text);
    }
    .irrWrap .irrTitle{
      margin:0 0 10px 0;
      font-size:13px;
      letter-spacing:.5px;
      text-transform:uppercase;
      color:var(--text);
      font-weight:900;
    }

    .twoCol{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width: 800px){
      .twoCol{grid-template-columns:1fr;}
    }

    .group-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:0 0 10px 0;
    }
    .group-title b{font-size:14px;color:var(--text)}

    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}

    /* 4 across buttons */
    .grid{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:repeat(3,minmax(0,1fr));}
    }
    @media (max-width: 600px){
      .grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }

    button.choice{
      border:1px solid rgba(0,0,0,.10);
      background:#ffffff;
      color:var(--text);
      padding:12px 10px;
      border-radius:12px;
      font-size:15px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      touch-action:manipulation;
      box-shadow:0 6px 16px rgba(0,0,0,.12);
    }
    button.choice.selected{
      border-color:var(--blue);
      background:var(--blue);
      color:#ffffff;
      box-shadow:0 10px 22px rgba(37,99,235,.22);
    }

    input[type="text"]{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background:#ffffff;
      color:var(--text);
      font-size:15px;
      box-shadow:0 6px 16px rgba(0,0,0,.10);
    }

    .outputTitle{margin:0 0 10px 0;}
    .outputTitle b{color:#e9eefc;font-size:14px}

    .output{
      white-space:pre-wrap;
      font-size:16px;
      line-height:1.35;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px;
      min-height:170px;
      color:#e9eefc;
    }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:#e9eefc;
      padding:12px 12px;
      border-radius:14px;
      font-size:15px;
      font-weight:900;
      cursor:pointer;
    }
    .btn.primary{
      border-color: rgba(255,255,255,.24);
      background: rgba(255,255,255,.10);
    }
    .btn.danger{
      border-color: rgba(193,18,31,.55);
      background: rgba(193,18,31,.18);
    }

    .miniRow{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width: 800px){
      .miniRow{grid-template-columns:1fr;}
    }

    .followOut{
      white-space:pre-wrap;
      font-size:16px;
      line-height:1.35;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px;
      min-height:120px;
      color:#e9eefc;
    }
  </style>
</head>

<body>
<header>
  <h1>MFD Size-Up Builder</h1>
  <div class="hint">Tap selections → paragraphs update → Copy.</div>
</header>

<div class="wrap">

  <!-- Controls -->
  <div class="card" id="controls"></div>

  <!-- Generated Size-Up -->
  <div class="card">
    <div class="outputTitle"><b>Generated Size-Up</b></div>
    <div class="output" id="outputBox">Make selections to build your size-up.</div>
    <div class="row">
      <button class="btn primary" id="copyBtn">Copy Size-Up</button>
      <button class="btn danger" id="clearBtn">Clear All</button>
    </div>
  </div>

  <!-- Follow-Up Report -->
  <div class="card">
    <div class="outputTitle"><b>Generated Follow-Up Report</b></div>
    <div class="followOut" id="followOutputBox">Make selections to build your follow-up report.</div>
    <div class="row">
      <button class="btn primary" id="copyFollowBtn">Copy Follow-Up</button>
      <button class="btn danger" id="clearFollowBtn">Clear Follow-Up</button>
    </div>
  </div>

</div>

<script>
  // Offline cache
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("service-worker.js"));
  }

  // ---------- Core Groups (Size-Up) ----------
  const CONFIG = [
    // Battalion / Apparatus
    { key:"battalion", title:"Battalion", mode:"single", options:[
      { value:"BC1", label:"BC1", phrase:"BC1" },
      { value:"BC2", label:"BC2", phrase:"BC2" }
    ]},
    { key:"apparatus", title:"Apparatus", mode:"single", options:[
      { value:"Trk 1",  label:"Trk 1",  phrase:"Trk 1" },
      { value:"Eng 2",  label:"Eng 2",  phrase:"Eng 2" },
      { value:"Trk 3",  label:"Trk 3",  phrase:"Trk 3" },
      { value:"Eng 4",  label:"Eng 4",  phrase:"Eng 4" },
      { value:"Trk 5",  label:"Trk 5",  phrase:"Trk 5" },
      { value:"Eng 6",  label:"Eng 6",  phrase:"Eng 6" },
      { value:"Eng 7",  label:"Eng 7",  phrase:"Eng 7" },
      { value:"Trk 9",  label:"Trk 9",  phrase:"Trk 9" },
      { value:"Eng 10", label:"Eng 10", phrase:"Eng 10" },
      { value:"Trk 11", label:"Trk 11", phrase:"Trk 11" },
      { value:"Med 1",  label:"Med 1",  phrase:"Med 1" },
      { value:"Med 2",  label:"Med 2",  phrase:"Med 2" },
      { value:"Med 3",  label:"Med 3",  phrase:"Med 3" },
      { value:"Med 5",  label:"Med 5",  phrase:"Med 5" },
      { value:"Med 6",  label:"Med 6",  phrase:"Med 6" },
      { value:"Med 7",  label:"Med 7",  phrase:"Med 7" },
      { value:"Med 9",  label:"Med 9",  phrase:"Med 9" },
      { value:"Med 10", label:"Med 10", phrase:"Med 10" },
      { value:"Med 11", label:"Med 11", phrase:"Med 11" }
    ]},

    // IRR: Building side
    { key:"buildingSize", title:"Building Size", mode:"single", options:[
      { value:"Small",  label:"Small",  phrase:"Small" },
      { value:"Medium", label:"Medium", phrase:"Medium" },
      { value:"Large",  label:"Large",  phrase:"Large" },
      { value:"Mega",   label:"Mega",   phrase:"Mega" }
    ]},
    { key:"height", title:"Building Height", mode:"single", options:[
      { value:"1", label:"1", phrase:"1 story" },
      { value:"2", label:"2", phrase:"2 story" },
      { value:"3", label:"3", phrase:"3 story" },
      { value:"4", label:"4", phrase:"4 story" },
      { value:"5", label:"5", phrase:"5 story" }
    ]},
    { key:"occupancy", title:"Occupancy Type", mode:"single", options:[
      { value:"house", label:"House", phrase:"house" },
      { value:"apartment", label:"Apartment", phrase:"apartment" },
      { value:"strip", label:"Strip Center", phrase:"strip center" },
      { value:"commercial", label:"Commercial", phrase:"commercial" },
      { value:"other", label:"Other", phrase:"" }
    ]},

    // IRR: Problem side
    { key:"conditions", title:"Condition", mode:"single", options:[
      { value:"nothing", label:"Nothing Showing", phrase:"nothing showing" },
      { value:"light", label:"Light Smoke", phrase:"light smoke" },
      { value:"heavy", label:"Heavy Smoke", phrase:"heavy smoke" },
      { value:"working", label:"Working Fire", phrase:"working fire" },
      { value:"defensive", label:"Defensive Conditions", phrase:"defensive conditions" }
    ]},
    { key:"problemSides", title:"Location of the Problem (multi)", mode:"multi", options:[
      { value:"Alpha", label:"Alpha", phrase:"alpha" },
      { value:"Bravo", label:"Bravo", phrase:"bravo" },
      { value:"Charlie", label:"Charlie", phrase:"charlie" },
      { value:"Delta", label:"Delta", phrase:"delta" }
    ]},

    // IAP
    { key:"iapTasks", title:"Task (multi)", mode:"multi", options:[
      { value:"Investigate", label:"Investigate", phrase:"investigating" },
      { value:"Water Supply", label:"Water Supply", phrase:"setting up water supply" },
      { value:"Attack Line", label:"Attack Line", phrase:"attack line" },
      { value:"Rescue", label:"Rescue", phrase:"rescue" },
      { value:"OEO", label:"OEO", phrase:"OEO" },
      { value:"Defensive Op", label:"Defensive Op", phrase:"defensive operations" }
    ]},
    { key:"iapLocation", title:"IAP Location", mode:"single", options:[
      { value:"Alpha", label:"Alpha", phrase:"alpha" },
      { value:"Bravo", label:"Bravo", phrase:"bravo" },
      { value:"Charlie", label:"Charlie", phrase:"charlie" },
      { value:"Delta", label:"Delta", phrase:"delta" }
    ]},
    { key:"iapObjectives", title:"Objective (multi)", mode:"multi", options:[
      { value:"Fire Attack", label:"Fire Attack", phrase:"fire attack" },
      { value:"Primary Search", label:"Primary Search", phrase:"primary search" }
    ]},

    // Strategy
    { key:"strategy", title:"Strategy", mode:"single", options:[
      { value:"Offensive", label:"Offensive", phrase:"offensive" },
      { value:"Defensive", label:"Defensive", phrase:"defensive" }
    ]}
  ];

  // ---------- Follow-Up Controls ----------
  const FOLLOW = [
    { key:"r360", title:"Results of the 360", mode:"single", options:[
      { value:"Not completed", label:"Not completed", phrase:"360 not completed" },
      { value:"Completed", label:"Completed", phrase:"360 completed" },
      { value:"Free text", label:"Free text", phrase:"" }
    ]}
  ];

  // ---------- State ----------
  const state = {};
  const fstate = {};
  const controlsEl = document.getElementById("controls");
  const outputBox = document.getElementById("outputBox");
  const followOutputBox = document.getElementById("followOutputBox");

  function init(){
    renderControls();
    updateOutputs();

    document.getElementById("copyBtn").addEventListener("click", () => copyFrom(outputBox, "Copied size-up!"));
    document.getElementById("clearBtn").addEventListener("click", clearAll);

    document.getElementById("copyFollowBtn").addEventListener("click", () => copyFrom(followOutputBox, "Copied follow-up!"));
    document.getElementById("clearFollowBtn").addEventListener("click", clearFollow);
  }

  function onChoice(group, value){
    if (group.mode === "single") state[group.key] = value;
    else {
      const current = Array.isArray(state[group.key]) ? state[group.key] : [];
      state[group.key] = current.includes(value) ? current.filter(v => v !== value) : [...current, value];
    }
    renderControls();
    updateOutputs();
  }

  function onFollowChoice(group, value){
    if (group.mode === "single") fstate[group.key] = value;
    else {
      const current = Array.isArray(fstate[group.key]) ? fstate[group.key] : [];
      fstate[group.key] = current.includes(value) ? current.filter(v => v !== value) : [...current, value];
    }
    renderControls();
    updateOutputs();
  }

  function renderGroup(groupKey, parentEl){
    const group = CONFIG.find(g => g.key === groupKey);
    if (!group) return;

    const wrap = document.createElement("div");
    wrap.style.marginBottom = "12px";

    const title = document.createElement("div");
    title.className = "group-title";
    title.innerHTML = `<b>${group.title}</b>`;
    wrap.appendChild(title);

    const grid = document.createElement("div");
    grid.className = "grid";

    group.options.forEach(opt => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.textContent = opt.label;
      btn.dataset.key = group.key;
      btn.dataset.value = opt.value;
      btn.addEventListener("click", () => onChoice(group, opt.value));
      grid.appendChild(btn);
    });

    wrap.appendChild(grid);

    // Occupancy Other input directly under Occupancy
    if (group.key === "occupancy" && state.occupancy === "other") {
      const label = document.createElement("label");
      label.textContent = "Occupancy Type (Other) – type here";
      wrap.appendChild(label);

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "e.g., school, church, warehouse…";
      input.value = state.occupancyOther || "";
      input.addEventListener("input", (e) => {
        state.occupancyOther = e.target.value;
        updateOutputs();
      });
      wrap.appendChild(input);
    }

    // Problem location free-text directly under sides
    if (group.key === "problemSides") {
      const label = document.createElement("label");
      label.textContent = "Location of the Problem (free text)";
      wrap.appendChild(label);

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "e.g., 2nd floor / roof line / rear storage…";
      input.value = state.problemLocationText || "";
      input.addEventListener("input", (e) => {
        state.problemLocationText = e.target.value;
        updateOutputs();
      });
      wrap.appendChild(input);
    }

    parentEl.appendChild(wrap);
  }

  function renderFollow(parentEl){
    // Results of the 360 buttons
    const group = FOLLOW[0];

    const wrap = document.createElement("div");
    wrap.style.marginBottom = "12px";

    const title = document.createElement("div");
    title.className = "group-title";
    title.innerHTML = `<b>${group.title}</b>`;
    wrap.appendChild(title);

    const grid = document.createElement("div");
    grid.className = "grid";

    group.options.forEach(opt => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.textContent = opt.label;
      btn.dataset.fkey = group.key;
      btn.dataset.fvalue = opt.value;
      btn.addEventListener("click", () => onFollowChoice(group, opt.value));
      grid.appendChild(btn);
    });
    wrap.appendChild(grid);

    // If Free text selected, show a free text box directly underneath
    if (fstate.r360 === "Free text") {
      const label = document.createElement("label");
      label.textContent = "Results of the 360 (free text)";
      wrap.appendChild(label);

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "e.g., 360 complete, Charlie-side access blocked, utilities secured…";
      input.value = fstate.r360text || "";
      input.addEventListener("input", (e) => {
        fstate.r360text = e.target.value;
        updateOutputs();
      });
      wrap.appendChild(input);
    }

    // Immediate safety concerns: free text
    const label2 = document.createElement("label");
    label2.textContent = "Immediate safety concerns (free text)";
    wrap.appendChild(label2);

    const input2 = document.createElement("input");
    input2.type = "text";
    input2.placeholder = "e.g., power lines down, propane tank involved, unstable wall, victims reported…";
    input2.value = fstate.safety || "";
    input2.addEventListener("input", (e) => {
      fstate.safety = e.target.value;
      updateOutputs();
    });
    wrap.appendChild(input2);

    parentEl.appendChild(wrap);
  }

  function renderControls(){
    controlsEl.innerHTML = "";

    // --- Batt / Apparatus ---
    const ops = document.createElement("div");
    ops.className = "block ops";
    ops.innerHTML = `<h2>Battalion / Apparatus</h2>`;
    renderGroup("battalion", ops);
    renderGroup("apparatus", ops);
    controlsEl.appendChild(ops);

    // --- IRR wrapper with two columns ---
    const irr = document.createElement("div");
    irr.className = "irrWrap";
    irr.innerHTML = `<div class="irrTitle">IRR</div>`;

    const irrCols = document.createElement("div");
    irrCols.className = "twoCol";

    const b = document.createElement("div");
    b.className = "block building";
    b.innerHTML = `<h2>Building Description</h2>`;
    renderGroup("buildingSize", b);
    renderGroup("height", b);
    renderGroup("occupancy", b);

    const p = document.createElement("div");
    p.className = "block problem";
    p.innerHTML = `<h2>Problem Description</h2>`;
    renderGroup("conditions", p);
    renderGroup("problemSides", p);

    irrCols.appendChild(b);
    irrCols.appendChild(p);
    irr.appendChild(irrCols);
    controlsEl.appendChild(irr);

    // --- IAP + Strategy row ---
    const row = document.createElement("div");
    row.className = "miniRow";

    const iap = document.createElement("div");
    iap.className = "block iap";
    iap.innerHTML = `<h2>Initial Action Plan</h2>`;
    renderGroup("iapTasks", iap);
    renderGroup("iapLocation", iap);
    renderGroup("iapObjectives", iap);

    const strat = document.createElement("div");
    strat.className = "block strategy";
    strat.innerHTML = `<h2>Strategy</h2>`;
    renderGroup("strategy", strat);

    row.appendChild(iap);
    row.appendChild(strat);
    controlsEl.appendChild(row);

    // --- Command (full width) ---
    const cmd = document.createElement("div");
    cmd.className = "block command";
    cmd.innerHTML = `<h2>Command</h2>`;
    const label = document.createElement("label");
    label.textContent = "Command Free Text";
    cmd.appendChild(label);
    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "e.g., Trk 1 is now Main Street Command";
    input.value = state.commandText || "";
    input.addEventListener("input", (e) => {
      state.commandText = e.target.value;
      updateOutputs();
    });
    cmd.appendChild(input);
    controlsEl.appendChild(cmd);

    // --- Follow-Up (full width) ---
    const follow = document.createElement("div");
    follow.className = "block follow";
    follow.innerHTML = `<h2>Follow Up Report</h2>`;
    renderFollow(follow);
    controlsEl.appendChild(follow);

    refreshSelectedUI();
  }

  function refreshSelectedUI(){
    // size-up buttons
    document.querySelectorAll("button.choice").forEach(btn => {
      if (btn.dataset.key) {
        const key = btn.dataset.key;
        const value = btn.dataset.value;
        const group = CONFIG.find(g => g.key === key);
        const current = state[key];
        const selected = (group.mode === "single")
          ? current === value
          : Array.isArray(current) && current.includes(value);
        btn.classList.toggle("selected", selected);
      }
      // follow buttons (same .choice class)
      if (btn.dataset.fkey) {
        const key = btn.dataset.fkey;
        const value = btn.dataset.fvalue;
        const current = fstate[key];
        btn.classList.toggle("selected", current === value);
      }
    });
  }

  function optionPhrase(groupKey, value){
    const group = CONFIG.find(g => g.key === groupKey);
    if (!group) return "";
    return (group.options.find(o => o.value === value)?.phrase || "").trim();
  }
  function singlePhrase(key){
    const val = state[key];
    if (!val) return "";
    return optionPhrase(key, val);
  }
  function multiList(key){
    const arr = Array.isArray(state[key]) ? state[key] : [];
    return arr.filter(Boolean);
  }
  function niceSidesDisplay(sidesArr){
    return sidesArr.map(s => s.toLowerCase()).join(" ");
  }

  function updateOutputs(){
    // --------- SIZE-UP PARAGRAPH ----------
    const battalion = (state.battalion || "").trim();
    const apparatus = (state.apparatus || "").trim();

    const bSize = (state.buildingSize || "").trim();
    const bHeight = singlePhrase("height"); // "2 story"
    let occ = "";
    if (state.occupancy === "other") occ = (state.occupancyOther || "").trim();
    else if (state.occupancy) occ = optionPhrase("occupancy", state.occupancy);

    const condition = singlePhrase("conditions"); // "heavy smoke"
    const sides = multiList("problemSides");
    const sidesText = sides.length ? niceSidesDisplay(sides) : "";
    const locFree = (state.problemLocationText || "").trim();

    const tasks = multiList("iapTasks").map(v => optionPhrase("iapTasks", v)).filter(Boolean);
    const iapLoc = singlePhrase("iapLocation");
    const objectives = multiList("iapObjectives").map(v => optionPhrase("iapObjectives", v)).filter(Boolean);

    const strategy = singlePhrase("strategy") || "offensive";
    const cmdText = (state.commandText || "").trim();

    const buildingParts = [bSize, bHeight, occ].filter(Boolean);
    const buildingPhrase = buildingParts.length ? buildingParts.join(" ") : "a structure";

    const probParts = [sidesText, locFree].filter(Boolean);
    const probPhrase = probParts.join(" ").trim();

    const taskPhrase = tasks.length ? tasks.join(", ") : "";
    const objPhrase = objectives.length ? objectives.join(", ") : "";

    const line1 =
      `${battalion ? battalion + " " : ""}` +
      `${apparatus ? "From " + apparatus + ", " : ""}` +
      `We are on scene with a ${buildingPhrase}` +
      `${condition ? ", with " + condition : ""}` +
      `${probPhrase ? " on the " + probPhrase : ""}.`;

    const line2 =
      `${apparatus ? apparatus + " " : ""}` +
      `${taskPhrase ? "will be " + taskPhrase : "will be operating"}` +
      `${iapLoc ? " on the " + iapLoc + " side" : ""}` +
      `${objPhrase ? " for " + objPhrase : ""}.`;

    const line3 =
      `We will be in the ${strategy} strategy` +
      `${cmdText ? ", we are " + cmdText : ""}.`;

    outputBox.textContent = [line1, line2, line3].join("\n\n");

    // --------- FOLLOW-UP PARAGRAPH ----------
    let r360 = "";
    if (fstate.r360 === "Not completed") r360 = "360 not completed.";
    if (fstate.r360 === "Completed") r360 = "360 completed.";
    if (fstate.r360 === "Free text") {
      r360 = (fstate.r360text || "").trim();
      if (r360 && !r360.endsWith(".")) r360 += ".";
    }
    const safety = (fstate.safety || "").trim();
    const safetyLine = safety ? `Immediate safety concerns: ${safety}${safety.endsWith(".") ? "" : "."}` : "";

    const followLines = [];
    if (r360) followLines.push(`Results of the 360: ${r360}`);
    if (safetyLine) followLines.push(safetyLine);
    if (!followLines.length) followLines.push("Follow-up report: (make selections above).");

    followOutputBox.textContent = followLines.join("\n");
  }

  async function copyFrom(el, msg){
    const text = el.textContent || "";
    try{
      await navigator.clipboard.writeText(text);
      alert(msg);
    }catch{
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      alert(msg);
    }
  }

  function clearAll(){
    Object.keys(state).forEach(k => delete state[k]);
    Object.keys(fstate).forEach(k => delete fstate[k]);
    renderControls();
    updateOutputs();
  }

  function clearFollow(){
    Object.keys(fstate).forEach(k => delete fstate[k]);
    renderControls();
    updateOutputs();
  }

  init();
</script>
</body>
</html>
